# Indeedバナーナレッジ分析システム

## プロジェクト概要
- **アプリ名**: Indeedバナーナレッジ分析システム
- **目的**: Indeed広告のATOMデータとバナークリエイティブを一元管理し、AI分析により営業の差別化を図る社内システム
- **主要機能**:
  1. Indeed広告のATOMデータ（実績）とバナー画像の一元管理
  2. バナーの訴求内容・デザイン傾向のタグ付けと蓄積
  3. AIによる画像からの自動タグ付け
  4. 業種・雇用形態別のCTRトップ5バナーの分析とAI要約
  5. **🆕 画像自動移行機能**: CSVインポート時にGoogle DriveやDropboxの画像を自動的にCloudflare R2に移行

## 現在の実装状況

### ✅ 完了した機能
- プロジェクト初期化（Hono + Cloudflare Pages）
- データベーススキーマ設計と実装
- **辞書マスターデータの定義と投入（ステップ3完了）**
- **UI実装完了（ステップ4完了）**:
  - データ登録・編集フォーム画面
  - 検索・分析ダッシュボード画面
  - バナー画像アップロード機能（R2連携）
  - **🆕 画像管理タブの追加**: 複数画像の一括アップロード、ドラッグ&ドロップ対応
- **バックエンドAPI実装完了**:
  - 辞書取得API（6種類）
  - バナーデータ登録API
  - バナー検索API（CTR降順ソート）
  - 画像アップロード/取得API
  - **🆕 一括画像アップロードAPI**: 複数ファイル対応、個別バリデーション
  - **🆕 URLから画像ダウンロード＆アップロードAPI**: Google Drive/Dropbox対応
- **AI機能実装完了（ステップ5完了）**:
  - AI機能1: バナー自動タグ付け（画像解析・OCR）
  - AI機能2: CTRトップ結果の傾向分析・AIサマリー生成
- **🆕 画像自動移行機能（2025-11-19）**:
  - CSVインポート時にGoogle Drive/Dropbox URLを検出
  - 外部ストレージから画像を自動ダウンロード
  - Cloudflare R2に自動アップロード
  - データベースURLを自動更新
- Gitリポジトリ設定

### 📊 データモデル

#### メインテーブル: `banner_knowledge`
| フィールド名 | データ型 | 説明 | データソース |
|------------|---------|------|------------|
| knowledge_id | TEXT | 一意のID（主キー） | 自動生成 |
| image_id | TEXT | 参照番号（必須・一意） | **CSV** |
| company_name | TEXT | 企業名 | **CSV** |
| job_title | TEXT | 求人（職種名） | **CSV** |
| impressions | INTEGER | 表示回数 | **CSV** |
| clicks | INTEGER | クリック数 | **CSV** |
| ctr | REAL | クリック率（CTR） | **CSV** |
| employment_type | TEXT | 雇用形態（辞書参照） | **手動入力必須** |
| banner_image_key | TEXT | R2バケットの画像キー | **手動アップロード必須** |
| banner_image_url | TEXT | 画像URL | **手動アップロード必須** |
| visual_type | TEXT | ビジュアル種別（辞書参照） | AI支援/手動 |
| main_color | TEXT | メインカラー（辞書参照） | AI支援/手動 |
| atmosphere | TEXT | 雰囲気（辞書参照） | AI支援/手動 |
| extracted_text | TEXT | OCR抽出テキスト | AI自動入力 |
| notes | TEXT | 補足メモ | 手動入力 |
| created_at | DATETIME | 登録日 | 自動生成 |
| updated_at | DATETIME | 更新日 | 自動更新 |

#### 辞書テーブル
- `employment_types` - 雇用形態辞書（6件: 正社員、アルバイト・パート、派遣社員、契約社員、業務委託、その他）
- `areas` - エリア辞書（48件: 全国 + 47都道府県）
- `main_appeals` - メイン訴求辞書（15件: 未経験歓迎、高収入・高時給、シフト自由など）
- `visual_types` - ビジュアル種別辞書（6件: 人物写真単体/複数、イラスト、テキストのみなど）
- `main_colors` - メインカラー辞書（8件: 青系、赤オレンジ系、緑系など、hex_color付き）
- `atmospheres` - 雰囲気辞書（7件: 明るい・元気、真面目・信頼、スタイリッシュなど）

#### 中間テーブル（多対多関係）
- `banner_areas` - バナーとエリアの関連（単一選択、CSVから自動マッピング）
- `banner_main_appeals` - バナーとメイン訴求の関連（複数選択、AI支援または手動）

### 🗄️ ストレージサービス
- **Cloudflare D1**: SQLiteベースのリレーショナルデータベース（メタデータ管理）
- **Cloudflare R2**: S3互換オブジェクトストレージ（バナー画像保存）

### 🔧 データベース管理コマンド
```bash
# ローカル開発用
npm run db:migrate:local    # マイグレーション実行（ローカル）
npm run db:seed             # 辞書マスターデータの投入
npm run db:reset            # データベースリセット（マイグレーション+シード投入）
npm run db:console:local    # SQLクエリ実行（ローカル）

# 本番環境用
npm run db:migrate:prod     # マイグレーション実行（本番）
npm run db:console:prod     # SQLクエリ実行（本番）
```

## 🚀 実装状況とロードマップ

### ✅ ステップ3: 辞書データの定義（完了）
- ✅ 雇用形態辞書の値定義（6件）
- ✅ エリア辞書の値定義（48件）
- ✅ メイン訴求辞書の値定義（15件）
- ✅ ビジュアル種別辞書の値定義（6件）
- ✅ メインカラー辞書の値定義（8件、hex_color付き）
- ✅ 雰囲気辞書の値定義（7件）

### ✅ ステップ4: UI・API実装（完了）
- ✅ **画面1: データ登録・編集フォーム**
  - **CSVインポート機能（JobsCampaigns形式対応）** ← 🆕 修正指示2
    - 参照番号、企業名、求人、都道府県、表示回数、クリック数、CTRをマッピング
    - エリア辞書との自動マッピング機能
    - 画像ID入力時の自動フォーム入力
  - バナー画像ドラッグ&ドロップアップロード（**必須**）
  - 雇用形態の手動選択（**必須**）
  - 辞書選択UI（エリア、メイン訴求など）
  - [AIでタグを提案]ボタン
- ✅ **画面2: 検索・分析ダッシュボード（3ペイン構成）**
  - 左: 検索エリア（職種、雇用形態、エリア、訴求で絞り込み）
  - 中央: 検索結果（CTR降順、バナー画像サムネイル表示）
  - 右: AI分析エリア（[この結果をAIで分析]ボタン）
- ✅ **バックエンドAPI**
  - **CSVインポートAPI（/api/banners/import-csv）** ← 🆕 修正指示2
  - 辞書取得API（6種類）
  - バナー登録API（多対多関係対応）
  - バナー検索API（CTR降順ソート、複数条件対応）
  - 画像アップロード/取得API（R2連携）

### ✅ ステップ5: AI統合（完了）
- ✅ **AI機能1: バナー自動タグ付け**
  - 画像解析API（OCR: 画像からテキスト抽出）
  - 自動タグ付け（ビジュアル種別・メインカラー・雰囲気・メイン訴求を自動判定）
  - データ登録フォームの[AIでタグを提案]ボタンで実行
  - 提案結果はフォームに自動入力され、ユーザーが修正可能
- ✅ **AI機能2: 傾向分析・AIサマリー生成**
  - CTRトップ結果から成功パターンをAI分析
  - クリエイティブ・色味・訴求内容の3観点で傾向を自動抽出
  - 検索・分析ダッシュボードの[この結果をAIで分析]ボタンで実行
  - 営業提案に使えるプロフェッショナルな分析レポートを生成
- **📝 今後の拡張機能候補**:
  - 本番AI API連携（OpenAI Vision、GPT-4等）
  - データ編集・削除機能
  - エクスポート機能
  - 一括CSV登録機能（複数バナーの同時登録）

## 技術スタック
- **フレームワーク**: Hono (TypeScript)
- **デプロイ**: Cloudflare Pages + Workers
- **データベース**: Cloudflare D1 (SQLite)
- **ストレージ**: Cloudflare R2 (バナー画像保存)
- **フロントエンド**: HTML + TailwindCSS + JavaScript (Vanilla)
- **AI統合**: シミュレーション実装（本番環境では外部AI APIと連携可能）
- **バージョン管理**: Git

## アクセス情報
- **ローカル開発URL**: http://localhost:3000
- **サンドボックス公開URL**: https://3000-idp189bz5v7ogpzgrbhhc-2b54fc91.sandbox.novita.ai
- **画面アクセス**:
  - ホーム: `/`
  - データ登録: `/register`
  - 検索・分析ダッシュボード: `/dashboard`

## デプロイ状況
- **ステータス**: ✅ 完成（全5ステップ + 修正指示2・3 + 画像自動移行機能完了）
- **最終更新**: 2025-11-19

## 📊 最新更新

### 🆕 画像自動移行機能（2025-11-19）
- ✅ **CSVインポート時の自動画像移行**
  - Google Drive URLの自動検出（/file/d/{ID}/view、/open?id={ID}パターン対応）
  - Dropbox URLの自動検出
  - 外部ストレージから画像を自動ダウンロード
  - Cloudflare R2に自動アップロード
  - データベースURLを新しいR2 URLに自動更新
  - 移行結果の詳細表示（成功件数、失敗件数、スキップ件数）
- ✅ **画像管理タブの追加**
  - 複数画像の一括アップロード機能
  - ドラッグ&ドロップ対応
  - ファイルバリデーション（形式・サイズチェック）
  - アップロード進捗表示
  - 結果表示（成功/失敗、URLコピー機能）
- ✅ **既存バナーの画像URL更新機能**
  - バナー詳細から「画像を変更」ボタンで簡単更新
  - 新しい画像をR2にアップロード
  - 既存のR2 URLを貼り付けて設定
  - 更新後に自動的にバナー一覧を再読み込み
- ✅ **新規API追加**
  - `POST /api/upload-batch`: 一括画像アップロード
  - `POST /api/upload-from-url`: URLから画像ダウンロード＆アップロード
  - `PATCH /api/banners/:id/image`: バナーの画像URL更新
- ✅ **セキュリティ強化**
  - 社内限定Google Driveファイルも安全に管理
  - 外部公開不要、完全にシステム内で画像管理

### 修正指示3: 検索・分析ダッシュボード機能拡張（2025-10-29）
- ✅ **企業名検索機能**追加
  - 企業名（company_name）での部分一致検索
- ✅ **検索結果表示の改善**
  - 表示回数（impressions）の追加表示
  - 企業名の表示追加
  - 求人名（job_title）の表記変更（旧：職種名）
- ✅ **AI分析機能の強化**
  - 分析結果に平均表示回数と平均クリック数を含める
  - 企業名情報をAI分析に含める

### 修正指示2: スキーマ変更とCSVインポート（2025-10-29）
- ✅ **スキーマ変更**
  - `product_name`フィールドを削除
  - `company_name`（企業名）を追加
  - `impressions`（表示回数）を追加
  - `area`を複数選択から単一選択に変更
- ✅ **CSVインポート機能**（JobsCampaigns形式対応）
  - 参照番号 → image_id
  - 企業名 → company_name
  - 求人 → job_title
  - 都道府県 → area（辞書自動マッピング）
  - 表示回数 → impressions
  - クリック数 → clicks
  - クリック率（CTR） → ctr
- ✅ **画像ID入力時の自動フォーム入力**
- ✅ **必須フィールドの明確化**

## 🚀 主要機能の使い方

### 1. データインポート（設定モーダル）

#### **CSVインポートワークフロー（推奨）**
1. **設定ボタンをクリック**してデータインポートモーダルを開く
2. **「CSVアップロード」タブを選択**
3. **CSVファイルをアップロード**（JobsCampaigns形式）
   - 対応列：参照番号、企業名、求人、都道府県、表示回数、クリック数、クリック率（CTR）、画像のURL
   - エリア名（「東京都」など）は自動的に辞書コードに変換
   - **🆕 画像URLの自動移行**: Google DriveやDropboxの画像URLを自動検出し、Cloudflare R2に移行
4. **[CSVをインポート]ボタン**をクリック
5. インポート結果を確認
   - データ登録件数
   - **📸 画像移行結果**: 成功件数、失敗件数、スキップ件数

#### **画像管理タブ（個別アップロード）**
1. **設定ボタンをクリック**してデータインポートモーダルを開く
2. **「画像管理」タブを選択**
3. **画像ファイルを選択**
   - ドラッグ&ドロップまたはクリックで複数ファイル選択
   - 対応形式: JPG, PNG, GIF, WebP (最大5MB)
4. **[画像をアップロード]ボタン**をクリック
5. アップロード結果を確認
   - 各画像のCloudflare R2 URLを取得
   - URLをコピーしてバナーデータに設定可能

#### **手動入力ワークフロー**
1. **画像ID（参照番号）**を入力（必須）
2. **企業名、求人、エリア**などのATOMデータを手動入力
3. **バナー画像をアップロード**（必須）
4. **雇用形態を選択**（必須）
5. **AI支援または手動でタグを設定**
6. **[保存]ボタン**でデータベースに登録

### 2. 検索・分析（/dashboard）
1. **左ペイン - 検索条件入力**
   - **企業名**：部分一致検索（例：「亀山」で検索）
   - **求人**：部分一致検索（例：「製造」「エンジニア」で検索）
   - **雇用形態**：複数選択可能
   - **エリア**：複数選択可能（例：「東京都」「神奈川県」）
   - **メイン訴求**：複数選択可能
   - **表示件数**：上位5件/10件/20件/50件
2. **[検索実行]ボタン**をクリック
3. **中央ペイン - 検索結果表示**
   - CTR降順でランキング表示
   - バナー画像サムネイル付き
   - 企業名、求人名、表示回数、クリック数、CTRを表示
   - メイン訴求タグを表示
   - **[詳細]ボタン**でバナー詳細モーダルを開く
4. **バナー詳細モーダル**
   - バナー画像の大きな表示
   - **[画像を変更]ボタン**で画像URL更新モーダルを開く
     - 新しい画像をR2にアップロード
     - または既存のR2 URLを貼り付け
   - 基本情報（企業名、求人、雇用形態、実績データ）
   - メイン・サブアピール、エリア情報
   - **[このバナーをAI分析]ボタン**で個別分析
5. **右ペイン - AI分析**
   - **[この結果をAIで分析]ボタン**をクリック
   - CTRトップ結果からクリエイティブ・色味・訴求の傾向を自動分析
   - 平均表示回数、平均クリック数、平均CTRを含めた分析レポートを生成
   - 営業提案用のプロフェッショナルなサマリーを作成
6. **[分析結果をコピー]ボタン**でクリップボードにコピー

## 📋 辞書マスターデータ詳細

### 1. 雇用形態辞書（6件）
| コード | 名称 |
|--------|------|
| fulltime | 正社員 |
| parttime | アルバイト・パート |
| dispatch | 派遣社員 |
| contract | 契約社員 |
| commission | 業務委託 |
| other | その他 |

### 2. エリア辞書（48件）
全国 + 47都道府県（北海道〜沖縄県）

### 3. メイン訴求辞書（15件）
未経験歓迎、高収入・高時給、シフト自由・選べる、Wワーク・副業OK、リモートワーク・在宅OK、駅チカ・通勤便利、主婦・主夫歓迎、シニア活躍中、ミドル活躍中、オープニングスタッフ、資格取得支援、土日祝休み、正社員登用あり、髪色・服装自由、短時間・短期OK

### 4. ビジュアル種別辞書（6件）
人物写真（単体）、人物写真（複数）、イラスト、テキストのみ、商品・風景写真、その他

### 5. メインカラー辞書（8件）
| コード | 名称 | カラーコード |
|--------|------|-------------|
| blue | 青系 | #0066CC |
| red_orange | 赤・オレンジ系 | #FF6600 |
| green | 緑系 | #00AA44 |
| yellow | 黄系 | #FFD700 |
| purple | 紫系 | #9933CC |
| pink | ピンク系 | #FF66AA |
| black | モノクロ・黒 | #333333 |
| white_colorful | 白ベース・カラフル | #FFFFFF |

### 6. 雰囲気辞書（7件）
明るい・元気、真面目・信頼・プロフェッショナル、スタイリッシュ・先進的、優しい・安心・温かい、クール・かっこいい、シニア向け・落ち着いた、インパクト重視
